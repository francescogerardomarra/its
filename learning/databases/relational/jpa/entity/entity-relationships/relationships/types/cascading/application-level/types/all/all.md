# `CascadeType.ALL`

In JPA, when you define cascading behavior using `CascadeType.ALL` in your entity's
annotations (like `@OneToMany`), it ensures that operations performed on the parent 
entity will automatically propagate to the related child entities, regardless of whether 
you're using `EntityManager` or Spring Data JPA repositories.

Spring Data JPA repositories (like `JpaRepository`) are built on top of JPA and
provide automatic implementation of basic CRUD operations.
These operations respect the cascading behavior defined in your entity mappings.

Let’s clarify this with an example **with `CascadeType.ALL`**

You have the following entities: `User` and `Order`.

We have two entities: `User` and `Order`. The `User` entity has a **OneToMany** relationship
with the `Order` entity, and we apply `CascadeType.ALL` to ensure that any persistence
operations on the `User` entity (such as `save()`, `delete()`, etc.) are cascaded to
its associated `Order` entities.

```java
// User Entity
@Entity
@Table(name = "User", schema = "shop_schema")
public class User {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "user_id")
    private Integer userId;

    @Column(name = "username", nullable = false, unique = true, length = 50)
    private String username;

    @OneToMany(mappedBy = "user", cascade = CascadeType.ALL)
    private List<Order> orders;

    // Other fields, constructors, getters and setters
}
```

**In this example:**
- `@OneToMany(mappedBy = "user", cascade = CascadeType.ALL)`:
  - the `User` entity is the parent entity, and it cascades all persistence operations
  (persist, merge, remove, refresh, and detach) to the related `Order` entities;
- `mappedBy` indicates that the `Order` entity owns the relationship,
i.e., it holds the foreign key to the `User` entity.

```java
// Order Entity
@Entity
@Table(name = "Order", schema = "shop_schema")
public class Order {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "order_id")
    private Integer orderId;

    @ManyToOne
    @JoinColumn(name = "user_id_fk", nullable = false)
    private User user;

    @Column(name = "order_date", nullable = false)
    private LocalDateTime orderDate = LocalDateTime.now();

    @Column(name = "status", nullable = false, length = 20)
    @Enumerated(EnumType.STRING)
    private OrderStatus status = OrderStatus.PENDING;

    // Other fields, constructors, getters, and setters
}
```
**Here:**
- `@ManyToOne`: the `Order` entity holds a reference to the parent `User`.
- `@JoinColumn(name = "user_id_fk", nullable = false)`: this defines the foreign key column in the `Order` table, which references the `User` entity.

## Demonstration of `CascadeType.ALL` using `JpaRepository`
Let's say we want to save a `User` along with their `Order` entities in the database.
The cascading behavior ensures that when we save a `User`, any associated `Order`
entities will also be saved (persisted) automatically.

```
Saving User with Orders (CascadeType.ALL in action)
User user = new User();
user.setUsername("john_doe");

Order order1 = new Order();
order1.setStatus(OrderStatus.PENDING);
order1.setUser(user);

Order order2 = new Order();
order2.setStatus(OrderStatus.PENDING);
order2.setUser(user);

user.setOrders(Arrays.asList(order1, order2));

userRepository.save(user); // This will cascade to save the Orders as well
```
**Here’s what happens:**
- `User` is saved: the `User` entity is saved via `userRepository.save(user)`.
- Cascade to Orders: the `CascadeType.ALL` means that when the `User` entity is saved,
the associated `Order` entities (the ones linked to user) will also be persisted.

## What Happens at the Database Level
When the above code executes, the following operations occur at the database level
(assuming we are using PostgreSQL):
1. Insert into `User` table:
   - a new record is inserted into the `shop_schema.User` table.
   - `user_id`, `username`, and any other fields are inserted.
2. Insert into `Order` table:
   - for each associated `Order` entity, a new record is inserted into the `shop_schema.Order` table.
   - the `user_id_fk` foreign key column is populated with the `user_id` of the newly inserted `User` entity.

**Example SQL Insert Operations (after save())**
```
-- Insert into User table
INSERT INTO shop_schema.User (username, created_at)
VALUES ('john_doe', CURRENT_TIMESTAMP);

-- Assume user_id = 1 (auto-generated by PostgreSQL)

-- Insert into Order table for each associated Order
INSERT INTO shop_schema.Order (user_id_fk, order_date, status)
VALUES (1, CURRENT_TIMESTAMP, 'pending');

INSERT INTO shop_schema.Order (user_id_fk, order_date, status)
VALUES (1, CURRENT_TIMESTAMP, 'pending');
```
- the foreign key relationship ensures that each `Order` is linked to the `User` via the `user_id_fk` column;
- `CascadeType.ALL` ensures that both the `User` and `Order` entities are persisted in the same transaction.

## Additional Considerations
- What happens if the `User` is removed?
  - since we defined `CascadeType.ALL`, deleting a `User` will also
  automatically delete all associated `Order` entities from the database.
  - example:
  ```
  userRepository.delete(user);  // This will delete both the user and their orders
  ```
  at the database level:
  ```java
  DELETE FROM shop_schema.Order WHERE user_id_fk = 1;
  DELETE FROM shop_schema.User WHERE user_id = 1;
  ```
  - **Changes on existing entities (e.g., `User` or `Order`):** if a `User` entity is updated using `save()`, 
  it will also cascade updates to the associated `Order` entities.
